$(function(){function e(){var e=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;e?function(){function t(e){if(!(e in o)){o[e]=!0;for(var t=Object.keys(o).filter(function(e){return o[e]}),n=0;n<t.length;n++)t[n].length>16&&(t.splice(n,1),n--);f=t[0]}}function n(e){e.split("\r\n").forEach(function(e,n,a){if(~e.indexOf("a=candidate")){var o=e.split(" "),i=o[4],r=o[7];"host"===r&&t(i)}else if(~e.indexOf("c=")){var o=e.split(" "),i=o[2];t(i)}})}var a=new e({iceServers:[]});a.createDataChannel("",{reliable:!1}),a.onicecandidate=function(e){e.candidate&&n("a="+e.candidate.candidate)},a.createOffer(function(e){n(e.sdp),a.setLocalDescription(e)},function(e){console.warn("offer failed",e)});var o=Object.create(null);o["0.0.0.0"]=!1}():console.warn("请使用主流浏览器：chrome,firefox,opera,safari")}function t(){$.ajax({type:"GET",url:ctxs+"/turntable/h5/saveTimes?tel_num="+s.tel_num+"&type=2&str="+f+"&time="+ +new Date,dataType:"jsonp",jsonp:"callback",jsonpCallback:"share",success:function(e){},error:function(e){}})}function n(e){e.preventDefault(),e.target.addEventListener("mousemove",a)}function a(e){e.preventDefault(),i(e.pageX,e.pageY)}function o(e){e.preventDefault();var t=e.touches[0];i(t.pageX,t.pageY)}function i(e,t){h.beginPath(),h.arc(e-u.offsetLeft,t-u.offsetTop,20,0,2*Math.PI),h.closePath(),h.fillStyle="#dddddd",h.fill(),r()}function r(){for(var e=h.getImageData(0,0,v,p),t=e.data,n=t.length,a=0,o=0;o<n;o+=4){var i=t[o+3];i<10&&a++}var r=a/(n/4);r>=.4&&d&&(d=!1,c())}function c(){$(".scratch-area").addClass("area-relative"),$(".show-lottery").show(),t(),$("#degree").text("0")}var s=new GetQueryString,f="",d=!0;e(),$(".scratch-area-child").on("click",function(){$(".scratch-area").removeClass("area-relative"),$("#scratch-area").addClass("scratch-area-style"),$(this).remove()}),$(".show-lottery").on("click",function(){$(window).usrLoad()});var l=document.getElementById("scratch-area"),u=document.getElementById("lottery-canvas");u.width=l.offsetWidth,u.height=l.offsetHeight,u.style.height=u.height+"px",u.style.width=u.width+"px";var h=u.getContext("2d"),v=l.offsetWidth,p=l.offsetHeight,g=new Image;g.src="dist/images/lottery-scratch-area.jpg",g.onload=function(){h.drawImage(g,0,0,v,p),h.globalCompositeOperation="destination-out"},u.addEventListener("mousedown",n),u.addEventListener("mouseup",function(e){this.removeEventListener("mousemove",a)}),u.addEventListener("touchmove",o)});